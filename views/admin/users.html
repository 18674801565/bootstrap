<h1 class="page-header">功能</h1>

<a class="btn btn-info" style="margin-bottom: 10px"
   data-toggle="modal" data-target="#myModal" onclick="addUser()">添加用户</a>
<h2 class="sub-header">列表</h2>
<div class="table-responsive">
    <table class="table table-striped" id="table-striped">
        <thead>
        <tr>
            <th>编号</th>
            <th>用户名</th>
            <th>密码</th>
            <th>身份</th>
            <th>状态</th>
            <th>操作</th>
        </tr>
        </thead>
        <tbody>
        <% for(let u of $data.users){
        %>
        <tr>
            <td><%= u.id%></td>
            <td><%= u.user_name%></td>
            <td><%= u.password %></td>
            <%
            if(u.role_id=='1'||u.role_id==1){
            %>
            <td>用户</td>
            <%
            }else if(u.role_id==2){
            %>
            <td>管理员</td>
            <%
            }else{
            %>
            <td>未知</td>
            <%
            }
            %>

            <td><%= u.state==1 ?'可用':'不可用' %></td>
            <td class="td_handle">
                <a class="btn btn-info" data-toggle="modal" data-target="#myModal" onclick="alterUser('<%= u%>')">修改</a>
                <a class="btn btn-info" data-toggle="modal" data-target="#myModal"
                   onclick="deleteUser('<%= u%>')">删除</a>
            </td>
        </tr>
        <%
        }
        %>

        </tbody>

    </table>


    <script src="../../static/common/js/jqPaginator.min.js" type="text/javascript"></script>
    <link href="../../static/common/css/myPage.css" rel="stylesheet" type="text/css"/>
    <script type="text/javascript">
        function loadData(num) {
            $("#PageCount").val();
        }
    </script>

    <form id="form1" runat="server">
        <div>
        </div>
        <div style="display: flex;align-items: center;justify-content: center">
            <ul class="pagination" id="pagination">
            </ul>
            <input type="hidden" id="PageCount" runat="server" value="<%= $data.count%>"/>
            <input type="hidden" id="PageSize" runat="server" value="<%= 6%>"/>
            <input type="hidden" id="countindex" runat="server" value="10"/>
            <!--设置最多显示的页码数 可以手动设置 默认为7-->
            <input type="hidden" id="visiblePages" runat="server" value="5"/>
        </div>
        <script>
            function exeData(num, type) {
                loadData(num);
                loadpage();
            }

            function loadpage() {
                var myPageCount = Math.ceil($("#PageCount").val());
                var myPageSize = parseInt($("#PageSize").val());
                var countindex = myPageCount % myPageSize > 0 ? (myPageCount / myPageSize) + 1 : (myPageCount / myPageSize);
                $("#countindex").val(countindex);

                $.jqPaginator('#pagination', {
                    totalPages: parseInt($("#countindex").val()),
                    visiblePages: parseInt($("#visiblePages").val()),
                    currentPage: 1,
                    first: '<li class="first"><a href="javascript:;" onclick="toPage(1)">首页</a></li>',
                    prev: '<li class="prev"><a href="javascript:;" onclick="toPage({{page}})"><i class="arrow arrow2"></i>上一页</a></li>',
                    next: '<li class="next"><a href="javascript:;" onclick="toPage({{page}})">下一页<i class="arrow arrow3"></i></a></li>',
                    last: '<li class="last"><a href="javascript:;" onclick="toPage({{page}})">末页</a></li>',
                    page: '<li class="page"><a href="javascript:;" onclick="toPage({{page}})">{{page}}</a></li>',
                    onPageChange: function (num, type) {
                        if (type == "change") {
                            exeData(num, type);
                        }
                    }
                });
            }

            $(function () {
                loadData(1);
                loadpage();
            });

            function toPage(index) {
                let ind = parseInt(index);
                $.post({
                    url: "/admin/user/paging",
                    datType: 'text',
                    async: false,
                    data: {
                        currentPage: ind,
                        countPage: parseInt($("#countindex").val()),
                        pageSize: parseInt($("#PageSize").val())
                    },
                    success: function (data) {
                        //渲染分页数据
                        $("#table-striped").empty()
                        $("#table-striped").append(data)
                    },
                    error: function () {

                    }
                })
            }
        </script>
    </form>

</div>

<!-- 模态框（Modal） -->
<div class="modal fade" id="myModal" tabindex="-1" user="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close sureClose" data-dismiss="modal" aria-hidden="true">
                    &times;
                </button>
                <h4 class="modal-title" id="myModalLabel">

                </h4>
            </div>
            <div class="modal-body" style="height: 270px;">
                <form>
                    <input type="hidden" id="userId" value="">
                    <div class="form-group" style="height: 50px">
                        <label for="userName" class="col-sm-2 control-label" style="height: 34px;
                                                                                                display: inline-block;
                                                                                                line-height: 34px;">
                            用户名</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="userName" placeholder="请输入用户名">
                        </div>
                    </div>
                    <div class="form-group" style="height: 45px">
                        <label for="password" class="col-sm-2 control-label" style="height: 34px;
                                                                                                display: inline-block;
                                                                                                line-height: 34px;">
                            密码</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="password" placeholder="请输入用户名">
                        </div>
                    </div>
                    <div class="form-group" style="height: 50px">
                        <label for="idMark" class="col-sm-2 control-label" style="height: 34px;
                                                                                                    display: inline-block;
                                                                                                    line-height: 34px;
                                                                                                    margin-top: 10px">
                            身份</label>
                        <div class="col-sm-10">
                            <select id="idMark"
                                    style="
                                                        display: block;
                                                        width: 100%;
                                                        height: 34px;
                                                        padding: 6px 12px;
                                                        font-size: 14px;
                                                        line-height: 1.42857143;
                                                        color: #555;
                                                        background-color: #fff;
                                                        background-image: none;
                                                        border: 1px solid #ccc;
                                                        border-radius: 4px;
                                                        margin-top: 10px">
                                <option style="color: #555;" value="2">管理员</option>
                                <option style="color: #555;" value="1">用户</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group" style="height: 50px">
                        <label for="stateName" class="col-sm-2 control-label" style="height: 34px;
                                                                                                    display: inline-block;
                                                                                                    line-height: 34px;
                                                                                                    margin-top: 10px">
                            状态</label>
                        <div class="col-sm-10">
                            <select id="stateName"
                                    style="
                                                        display: block;
                                                        width: 100%;
                                                        height: 34px;
                                                        padding: 6px 12px;
                                                        font-size: 14px;
                                                        line-height: 1.42857143;
                                                        color: #555;
                                                        background-color: #fff;
                                                        background-image: none;
                                                        border: 1px solid #ccc;
                                                        border-radius: 4px;
                                                        margin-top: 10px">
                                <option style="color: #555;" value="2">不可用</option>
                                <option style="color: #555;" value="1">可用</option>
                                <option style="color: #555;" value="0">删除</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default sureClose" data-dismiss="modal">关闭
                </button>
                <button type="button" id="sure_alter" class="btn btn-primary">
                    确定
                </button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal -->
</div>
<script>
    //显示当前修改的角色
    function alterUser(user) {
        $("#myModalLabel").text("修改")
        $(".modal-body").css('display', 'block')
        let user_obj = JSON.parse(user);
        //修改框默认值
        $("#userId").val(user_obj.id)
        $("#userName").val(user_obj.user_name)
        $("#password").val(user_obj.password)
        $("#idMark").val(user_obj.role_id)
        $("#stateName").val(user_obj.state)


        $("#sure_alter").unbind('click').click(function () {
            if (isUserNull()) {
                let userId = $("#userId").val()
                let userName = $("#userName").val()
                let password = $("#password").val()
                let idMark = $("#idMark").val()
                let stateName = $("#stateName").val()

                $.post({
                    url: '/admin/alterUser',
                    dataType: 'json',
                    async: false,
                    data: {
                        userId: userId,
                        userName: userName,
                        password: password,
                        idMark: idMark,
                        stateName: stateName
                    },
                    success: function (data) {
                        $('#myModal').css('display', 'none')
                        $('.modal-backdrop').css('display', 'none')
                        //刷新列表
                        $.post({
                            url: '/admin/userList',
                            dataType: 'text',
                            async: false,
                            success: function (data) {
                                $("#res_body").empty()
                                $("#res_body").append(data)
                            },
                            error: function () {
                                toastr.info(data.msg)
                            }
                        })

                        toastr.success(data.msg);
                    },
                    error: function (data) {
                        $('#myModal').css('display', 'none')
                        $('.modal-backdrop').css('display', 'none')
                        toastr.error(data.msg);

                    }
                })

            } else {
                toastr.info('请填写完整！');
            }
        })
        return false
    }

    //删除当前角色
    function deleteUser(user) {
        $("#myModalLabel").text("删除")
        $(".modal-body").css('display', 'none')
        let user_obj = JSON.parse(user);
        let userId = user_obj.id;

        $("#sure_alter").unbind('click').click(function () {

            $.post({
                url: '/admin/deleteUser',
                dataType: 'json',
                async: false,
                data: {
                    userId: userId,
                },
                success: function (data) {
                    $('#myModal').css('display', 'none')
                    $('.modal-backdrop').css('display', 'none')
                    //刷新列表
                    $.post({
                        url: '/admin/userList',
                        dataType: 'text',
                        async: false,
                        success: function (data) {
                            $("#res_body").empty()
                            $("#res_body").append(data)
                            return false
                        },
                        error: function () {
                            toastr.info(data.msg)
                        }
                    })

                    toastr.success(data.msg);
                },
                error: function (data) {
                    $('#myModal').css('display', 'none')
                    $('.modal-backdrop').css('display', 'none')

                }
            })
            return false

        })
        return false
    }

    //添加角色
    function addUser() {
        $("#myModalLabel").text("添加")
        $(".modal-body").css('display', 'block')


        $("#sure_alter").unbind('click').click(function () {
            if (isUserNull()) {

                let userName = $("#userName").val()
                let password = $("#password").val()
                let idMark = $("#idMark").val()
                let stateName = $("#stateName").val()

                $.post({
                    url: '/admin/addUser',
                    dataType: 'json',
                    async: false,
                    data: {

                        userName: userName,
                        password: password,
                        idMark: idMark,
                        stateName: stateName
                    },
                    success: function (data) {
                        $('#myModal').css('display', 'none')
                        $('.modal-backdrop').css('display', 'none')
                        //刷新列表
                        $.post({
                            url: '/admin/userList',
                            dataType: 'text',
                            async: false,
                            success: function (data) {
                                $("#res_body").empty()
                                $("#res_body").append(data)
                            },
                            error: function () {
                                toastr.info(data.msg)
                            }
                        })

                        toastr.success(data.msg);
                    },
                    error: function (data) {
                        $('#myModal').css('display', 'none')
                        $('.modal-backdrop').css('display', 'none')
                        toastr.error(data.msg);

                    }
                })

            } else {
                toastr.info('请填写完整！');
            }
        })
        return false
    }

    //判断填写资料是否为空
    function isUserNull() {

        // let userId=  $("#userId").val()
        let userName = $("#userName").val()
        let password = $("#password").val()
        let idMark = $("#idMark").val()
        let stateName = $("#stateName").val()

        if (userName == null || userName == '' || userName == undefined) {
            return false
        }
        if (password == null || password == '' || password == undefined) {
            return false
        }
        if (idMark == null || idMark == '' || idMark == undefined) {
            return false
        }
        if (stateName == null || stateName == '' || stateName == undefined) {
            return false
        }
        console.log(userName + "-" + password + "-" + idMark + "-" + stateName)
        return true
    }
</script>